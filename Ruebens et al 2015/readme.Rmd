---
output: github_document
bibliography: bibliography.bib
always_allow_html: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```


## Ruebens, McPherron & Hublin 2015 - On the local Mousterian origin of the Châtelperronian: Integrating typo-technological, chronostratigraphic and contextual data

In @ruebens_local_2015 we included in the Supplementary Information a spreadsheet of summary data on Châtelperronian sites.  Here we show what some of those data look like by plotting the category 1 and 2 sites and listing some of the data.

```{r, load libraries and the data}

library(ggplot2)
library(ggrepel)
library(dplyr)
library(magrittr)
library(knitr)
library(sf)
library(raster)
library(RStoolbox)
library(leaflet)
library(maptools)
library(ggspatial)
library(ggmap)
webshot::install_phantomjs(force = TRUE)

# These CSV files are tabs one and two from the spreadsheet in the SI
# of Ruebens et al. 2015.  Some columns, like sitename, have names that need 
# to be corrected.
cp_sites1 = read.csv("data/Reubens_Category_1.csv", header = TRUE, sep = ',')%>%rename(Sitename = 'Site.name')
cp_sites2 = read.csv("data/Reubens_Category_2.csv", header = TRUE, sep = ',') %>%
  rename(Sitename = 'Site.name')

```


```{r, prep the data}

# Need to make an ROI
# Take the sites and create square around it
# Load the sites and make them to sf objects 
cp_sites1_sf <- st_as_sf(cp_sites1, coords = c("Long.", "Lat."), crs = 4326, agr = "constant")
cp_sites2_sf <- st_as_sf(cp_sites2, coords = c("Long.", "Lat."), crs = 4326, agr = "constant")

# Add this field so that both dataframes have the same columns
cp_sites1_sf$Concerns = NA

# Row bind them into one dataframe
cp_sites_sf <- rbind(cp_sites1_sf, cp_sites2_sf)

# And save it as a shapefile
st_write(cp_sites_sf, "data/Reubens_Sites.shp", append = FALSE)

# Read the ROI for Reubens map 
ReubensROI<-st_read("data/Reubens_ROI.shp")

```

#Leaflet version of the map

```{r, leaflet version}

htmltitle <- "<h5> Reubens 2015 Archaeological Sites </h5>"

mylabels <- paste(
  "Site Name: ", cp_sites_sf$Sitename, "<br/>",
  "Region: ", cp_sites_sf$Region, "<br/>",
  "Location: ", cp_sites_sf$Concerns) %>%lapply(htmltools::HTML)


m<-leaflet() %>% addTiles %>% addMarkers(data=cp_sites1_sf, popup = ~Sitename,label=mylabels,labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"))%>%
  addControl(html=htmltitle, position = "topright")
  
m







```


Here is a map of all Category 1 (Châtelperronian sites with good contextual information) and Category 2 (Châtelperronian sites needing some better contextual information) sites considered in @ruebens_local_2015.

```{r map}

bgmap <- brick("data/bgmap.tif")

map <- ggplot()
map = map + ggRGB(bgmap, r = 1, g = 2, b = 3,  ggLayer = TRUE)
map = map + geom_sf(data = ReubensROI, color = NA, fill = NA)
map = map + geom_sf(data = cp_sites_sf, size = 1.5, color = 'red')
map = map + ggrepel::geom_label_repel(data = cp_sites_sf,
                                      aes(label = Sitename, geometry = geometry),
                                      stat = "sf_coordinates", min.segment.length = 0,
                                      colour = "black", segment.colour = "black",
                                      label.size = 0.2, nudge_x = 0.5, size = 1,
                                      segment.alpha = .5, point.padding = .1,
                                      label.padding = .1)
map = map + ggtitle('Châtelperronian Sites', subtitle = 'Data from Ruebens et al. 2015')
map = map + annotation_scale(location = "bl", width_hint = 0.5) 
map = map + annotation_north_arrow(location = "br", which_north = "true", 
        pad_x = unit(0.25, "in"), pad_y = unit(0.3, "in"),
        style = north_arrow_fancy_orienteering)
map = map + xlab('Longitude') + ylab('Latitude')
map = map + coord_sf()
map 

```

Here are two views on the data themselves.  First the Category 1 sites.

```{r}

kable(cp_sites1_sf)

```


And the Category 2 sites.

```{r}

kable(cp_sites1_sf)

```

# To see this map in google view this file as a kml on google earth

```{r, google earth}

cp_sites_sp<-as(cp_sites_sf, "Spatial")

kmlPoints(cp_sites_sp,kmlfile = "Reubens_map.kml", kmlname="Reubens_map",icon="http://www.gstatic.com/mapspro/images/stock/962-wht-diamond-blank.png", name=paste(cp_sites_sp$Sitename), description = paste(cp_sites_sp$Concerns))



```

